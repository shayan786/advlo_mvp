function positionLocationText(){
  $('#location_text').css('top', ($('#hero_image').height() / 2));
}

function heroScroll(){
  var hero = $('#hero_image img');
  var heroFont = $('#location_text');
  $(window).scroll(function(){
    var s = $(window).scrollTop();
    hero.css('-webkit-transform','translateY(' + (s/1.5) + 'px');
    heroFont.css('-webkit-transform','translateY(' + (s/2) + 'px');
  })
}
function adventureScroll(){
  var hero = $('#main_image img');
  $(window).scroll(function(){
    var s = $(window).scrollTop();
    hero.css('-webkit-transform','translateY(' + (s/1.3) + 'px');
  })
}

function adventureHover(){
  $('.hover-block').hover(function(){
    $('.copy-'+$(this).attr('id')).stop().animate({
      opacity: 0
    },500)
    $(this).stop().animate({
      opacity: 1
    },140)
  },function(){
    $('.copy-'+$(this).attr('id')).stop().animate({
      opacity: 1
    },300)
    $(this).stop().animate({
      opacity: 0
    })
  })
}

function filterCatch(){
  if(location.pathname == '/adventures'){
    $(window).scroll(function(){
      var s = ($(window).scrollTop() + parseInt($('.filter-container').css('height')));
      var fixedHeight = $('.filter-container').position().top
      if(s > fixedHeight ){
        $('.filter-static').fadeIn();
        $('.filter-container').css('opacity',0)
      }else if( s < fixedHeight ){
        $('.filter-static').fadeOut('fast')
        $('.filter-container').css('opacity',1)
      }
    })
  }else{
    $(window).unbind('scroll');
  }
} 

function masonrySetup(){
  $('.js-masonry').masonry({
    isFitWidth: true,
    itemSelector: '.adventure-brick'
  });
}

function sizeSidebar(){
  $(document).ready(function(){
    $('.adventure-show-infographic').width($('.navigation-brick').last().width() - 32);
  })
}

function stopSidebarAtBottom(){
  $(window).scroll(function(){
    var scrollPosition = window.pageYOffset;
    var windowSize     = window.innerHeight;
    var bodyHeight     = document.body.offsetHeight;

    var distanceFromBottom = Math.max(bodyHeight - (scrollPosition + windowSize), 0);
    if(distanceFromBottom < 76){
      $('.adventure-show-container #desktop-adventure-nav').css({
        top: 'auto',
        position: 'absolute',
        right: '0px',
        bottom: '45px'
      })
      $('.adventure-show-container .adventure-show-infographic').css({
        position: 'absolute',
        bottom: '246px',
        top: 'auto'
      })
    }else{
      $('.adventure-show-container #desktop-adventure-nav').css({
        top: 'auto',
        position: 'fixed',
        bottom: '45px',
        top: '481px',
        right: '0px'
      })
      $('.adventure-show-container .adventure-show-infographic').css({
        position: 'fixed',
        bottom: 'auto',
        top: '100px'
      })
    }
  })
}


function navBarCatch(){
  $('#main_image img').load(function(){
    $(window).scroll(function(){
      var scrollPosition = window.pageYOffset;
      var windowSize     = window.innerHeight;
      var bodyHeight     = document.body.offsetHeight;
      var distanceFromBottom = Math.max(bodyHeight - (scrollPosition + windowSize), 0);
      var s = $(window).scrollTop();
      if(distanceFromBottom < 76){
      }else if(s > widthOfBrowser()){
        fixSidebar();
      }else{
        resetSideBar();
      }
    })
  })
}

function widthOfBrowser(){
  var windowWidth = $(window).width();
  if( windowWidth > 1090 ){
    return 240;
  }else if( windowWidth > 1060){
    return 230;
  }else if( windowWidth > 1040){
    return 220;
  }else if( windowWidth > 1020){
    return 213;
  }else if( windowWidth > 1000){
    return 190;
  }else if( windowWidth > 900){
    return 175;
  }
}

function fixSidebar(){
  $('#desktop-adventure-nav').css({
    position: 'fixed',
    right: '0px',
    top: '481px'
  })
}

function resetSideBar(){
  $('#desktop-adventure-nav').css({
    position: 'relative',
    top: '0px',
    right: '0px'
  })
}

function navigationBreadcrumbs(){
  $(document).ready(function() {
    $('a[href*=#]:not([href=#])').click(function() {
      if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
        var target = $(this.hash);
        target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
        if (target.length) {
          $('html,body').animate({
            scrollTop: target.offset().top-77
          }, 1000);
          return false;
        }
      }
    });
  });

  if($(window).height() < 705){
    $('.navigation-brick').last().hide();
  }
}

function centerProfileImage(){
  $('.guide-image').each(function(){
    var imageWidth = $(this).find('img').width();
    if( imageWidth > 300){
      $(this).find('img').css('margin-left','-40%');
    }else if(imageWidth > 250){
      $(this).find('img').css('margin-left','-20%');
    }else if(imageWidth > 200){
      $(this).find('img').css('margin-left','-10%');
    }
  })
}

function centerGuideImage(){
  $(window).load(function(){
    $('.guide-profile-image').each(function(){
      var imageWidth = $(this).find('img').width();
      if( imageWidth > 300){
        $(this).find('img').css('margin-left','-30%');
      }else if(imageWidth > 250){
        $(this).find('img').css('margin-left','-20%');
      }else if(imageWidth > 200){
        $(this).find('img').css('margin-left','-10%');
      }
    })
  })
}

function advPhotoInput(){
  $("#adv_cover_img").filestyle({input: false, icon: false, buttonText: "SET COVER IMAGE"});
  $("#adv_gallery_img").filestyle({input: false, icon: false, buttonText: "SELECT GALLERY IMAGES"});
}

function galleryToggle(){
  $('.gallery-image').click(function(){
    $('.gallery-image').removeClass('active');
    $('.modal-body img').attr('src', $(this).data('image'));
    $('.modal-body img').attr('id', $(this).attr('id'));
    $(this).addClass('active');
  })
}

function galleryModalClick(){
  var totalSlides = $('.gallery-image').size()
  $('.modal-body img').click(function(i){
    $('.modal-body img').removeClass()
    if($('.gallery-image').last().hasClass('active')){
      $('.gallery-image').removeClass('active');
      $('.gallery-image').first().addClass('active');
      $(this).attr('src', $('.active').data('image'));
    }else if(totalSlides > 1){
      $(this).attr('src', $('.active').next().data('image'));
      $('.active').next().addClass('active');
      $('.active').first().removeClass('active');
    }
  })
}

function galleryMasonry(){
  $('#gallery-masonry-container').imagesLoaded(function(){
    $('#gallery-masonry-container').masonry({
      isFitWidth: true,
      itemSelector: '.gallery-image',
    });
  })
}

function form_validator(){
  $('#adventure_edit_form').bootstrapValidator({
    fields: {
      'adventure[title]': {
        validators: {
          notEmpty: {
            message: 'The title is required and cannot be empty'
          }
        }
      },
      'adventure[category]': {
        validators: {
          notEmpty: {
            message: 'A category is required and cannot be empty'
          }
        }
      },
      'adventure[location]': {
        validators: {
          notEmpty: {
            message: 'The location is required and cannot be empty'
          }
        }
      },
      'adventure[summary]': {
        validators: {
          notEmpty: {
            message: 'The summary is required and cannot be empty'
          }
        }
      },
      'adventure[cap_min]': {
        validators: {
          notEmpty: {
            message: 'Min. req.'
          },
          integer: {
            message: 'Integer req.' 
          }
        }
      },
      'adventure[cap_max]': {
        validators: {
          notEmpty: {
            message: 'Max. req.'
          },
          integer: {
            message: 'Integer req.' 
          }
        }
      },
      'adventure[duration_num]': {
        validators: {
          notEmpty: {
            message: 'Cannot be empty'
          },
          integer: {
            message: 'Integer req.'
          }
        }
      },
      'adventure[price]': {
        validators: {
          notEmpty: {
            message: 'Cannot be empty'
          },
          integer: {
            message: 'Integer req.'
          }
        }
      },
      'adventure[price_type]': {
        validators: {
          notEmpty: {
            message: 'Please select price type'
          }
        }
      },
      'adventure[attachment]': {
        validators: {
          file: {
            extension: 'jpeg,jpg,png,tiff',
            type: 'image/jpeg,image/jpg,image/png,image/tiff',
            maxSize: 1024*10*1024, //10 MB
            message: 'Must have an adventure banner image'
          }
        }
      },
      'headline': {
        validators: {
          notEmpty: {
            message: 'Event title cannot be empty'
          }
        }
      },
      'description': {
        validators: {
          notEmpty: {
            message: 'Event title cannot be empty'
          }
        }
      }
    }
  });

  $('#adventure_iten_form').bootstrapValidator({
    fields: {
      'headline': {
        validators: {
          notEmpty: {
            message: 'Event title cannot be empty'
          }
        }
      },
      'description': {
        validators: {
          notEmpty: {
            message: 'Event description cannot be empty'
          }
        }
      }
    }
  });
}

function multiSelect(){
  $(document).ready(function() {
    $('.multiselect').multiselect();
  });
}


adventureShow = function() {
  galleryMasonry();
  galleryModalClick();
  galleryToggle();
  sizeSidebar();
  navBarCatch(); 
  navigationBreadcrumbs();
  adventureScroll();
  centerGuideImage();
  stopSidebarAtBottom();
};

adventureIndex = function() {
  positionLocationText();
  masonrySetup();
  filterCatch();
  heroScroll();
  adventureHover();
  centerProfileImage();
}

adventureCreate = function() {
  multiSelect();
  advPhotoInput();
  input_popover();
  input_datepicker();
  input_maxlength();
  create_tabs();
  form_validator();
}

//----------------FULL CALENDAR & SCHEDULE RELATED FUNCTIONS ------------
FSInitialize = function(adventure_id) {
  // Needs to change depending on mins, hours, days
  var eventDuration = '#{@adventure.duration_num}';

  $('#calendar').fullCalendar({
    defaultView: "agendaWeek",
    height: 600,
    eventDurationEditable: false,
    eventStartEditable: true,
    selectable: true, 
    slotDuration: '00:00:00',
    allDaySlot: false,
    header: {
      left: 'today prev,next',
      center: 'title',
      right: ''
    },

    //RENDER EXISTING BOOKING TIMES
    eventSources: [
      {
        url: '/events',
        type: 'GET',
        data: {
          adventure_id: adventure_id
        },
        error: function(data) {
          alert('Something went wrong!');
        },
        success: function() {
        }
      }
    ],

    //CREATE NEW EVENT
    select: function(start, end) {
      $.ajax({
        url: "/events",
        dataType: "JSON",
        data: {adventure_id: adventure_id, start_time: start, end_time: end},
        type: "POST",
        success: function(data){   
          $('#calendar').fullCalendar('renderEvent',data);
        }
      });
    },

    //DELETE AN EVENT
    eventClick: function(event) {
      var resp = confirm('Delete this event?');

      if(resp == true) {
        $.ajax({
          url: "/events/"+event.id,
          dataType: "JSON",
          data: {},
          type: "POST",
          method: "DELETE",
          success: function(data){   
            $('#calendar').fullCalendar('removeEvents', event.id);
          }
        });
      }
    },

    //UPDATE AN EVENT
    eventDrop: function(event, revertFunc) {
      $.ajax({
        url: "/events/"+event.id,
        dataType: "JSON",
        data: {start: event.start, end: event.end},
        type: "POST",
        method: "PUT",
        error: function(){   
          revertFunc();
        }
      });
    }
  });
}


adventureSchedule = function(adventure_id) {
  FSInitialize(adventure_id);
}

# Sidekiq interaction and startup script
files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/50_restart_sidekiq.sh":
    mode: "000755"
    content: |
      #!/bin/bash

      . /opt/elasticbeanstalk/hooks/common.sh
      . /opt/elasticbeanstalk/support/envvars

      set -xe

      EB_SCRIPT_DIR=$(/opt/elasticbeanstalk/bin/get-config container -k script_dir)
      EB_CONFIG_APP_CURRENT=$(/opt/elasticbeanstalk/bin/get-config container -k app_deploy_dir)
      EB_CONFIG_APP_LOGS=$(/opt/elasticbeanstalk/bin/get-config container -k app_log_dir)
      EB_CONFIG_APP_PIDS=$(/opt/elasticbeanstalk/bin/get-config container -k app_pid_dir)

      . $EB_SCRIPT_DIR/use-app-ruby.sh

      BUNDLE=`which bundle`
      SIDEKIQ=`which sidekiq`

      cd $EB_CONFIG_APP_CURRENT

      # for 2 instances of sidekiq, this can be increased are decreased, just make sure it is updated in the both areas
      for i in `seq 1 2`
      do
        PIDFILE=$EB_CONFIG_APP_PIDS/sidekiq-$i.pid

        # stop any running instance
        if [ -f $PIDFILE ]
        then
          SIDEKIQ_LIVES=$(/bin/ps -o pid= -p `cat $PIDFILE`)
            if [ -z $SIDEKIQ_LIVES ]
            then
               rm -rf $PIDFILE
            else
               kill -TERM `cat $PIDFILE`
            fi
        fi

        # start a new instance
        $BUNDLE exec $SIDEKIQ \
          -e production \
          -P $PIDFILE \
          -C $EB_CONFIG_APP_CURRENT/config/sidekiq.yml \
          -L $EB_CONFIG_APP_LOGS/sidekiq.log \
          -d
      done

  "/opt/elasticbeanstalk/hooks/appdeploy/pre/03_quiet_sidekiq.sh":
    mode: "000755"
    content: |
      #!/bin/bash

      . /opt/elasticbeanstalk/support/envvars

      EB_CONFIG_APP_PIDS=$(/opt/elasticbeanstalk/bin/get-config container -k app_pid_dir)

      # for 2 instances of sidekiq, this can be increased are decreased, just make sure it is updated in the both areas
      for i in `seq 1 2`
      do
        PIDFILE=$EB_CONFIG_APP_PIDS/sidekiq-$i.pid

        # quiet any running instance
        if [ -f $PIDFILE ]
        then
          SIDEKIQ_LIVES=$(/bin/ps -o pid= -p `cat $PIDFILE`)
            if [ -z $SIDEKIQ_LIVES ]
            then
               rm -rf $PIDFILE
            else
               kill -USR1 `cat $PIDFILE`
            fi
        fi
      done